<!DOCTYPE html>
<html lang="ru">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>Остров — кликабельные зоны + настройка</title>

<!-- Базовая карта и версии с подсветкой -->
<link rel="preload" as="image" href="1.jpg">
<link rel="preload" as="image" href="2.jpg">
<link rel="preload" as="image" href="3.jpg">
<link rel="preload" as="image" href="4.jpg">
<link rel="preload" as="image" href="5.jpg">
<link rel="preload" as="image" href="6.jpg">
<link rel="preload" as="image" href="7.jpg">
<link rel="preload" as="image" href="8.jpg">

<style>
  :root { --accent:#0ea5e9; --bg:#0e2230; }
  *{box-sizing:border-box}
  body{margin:0;font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif;background:var(--bg);color:#0f172a}
  .page{max-width:1100px;margin:0 auto;padding:16px;display:grid;gap:16px}
  @media (min-width:980px){.page{grid-template-columns:1fr 360px}}

  .card{background:#fff;border-radius:16px;box-shadow:0 10px 30px rgba(0,0,0,.15);overflow:hidden}
  .mapWrap{position:relative}
  .map{display:block;width:100%;height:auto}
  .toolbar{display:flex;gap:8px;align-items:center;padding:10px 12px;border-bottom:1px solid #e5e7eb;background:#fafafa}
  .toolbar label{display:inline-flex;align-items:center;gap:8px;font-weight:600}
  .btn{appearance:none;border:0;border-radius:12px;padding:10px 14px;font-weight:700;cursor:pointer;background:var(--accent);color:#fff}
  .btn.secondary{background:#e2e8f0;color:#0f172a}
  .muted{font-size:12px;color:#64748b}

  /* Зоны */
  .hotspot{cursor:pointer;pointer-events:all;fill:rgba(255,165,0,0)}
  .editing .hotspot{fill:rgba(255,165,0,.18)}
  .zone-outline{display:none;stroke:var(--accent);stroke-width:2;stroke-dasharray:6 6;fill:none}
  .editing .zone-outline{display:block}
  .handle{display:none;fill:#fff;stroke:var(--accent);stroke-width:2}
  .editing .handle{display:block}
  .zone-label{display:none;font:700 12px/1 sans-serif;fill:#111;background:#fff}
  .editing .zone-label{display:block}

  /* Панель настройки */
  .panel{background:#fff;border-radius:16px;box-shadow:0 10px 30px rgba(0,0,0,.15);padding:14px 14px 6px}
  .panel h3{margin:4px 0 10px}
  .field{display:grid;gap:6px;margin:8px 0}
  .field.inline{grid-template-columns:1fr 1fr;gap:8px}
  .field label{font-size:12px;color:#334155}
  input[type="text"],input[type="number"],select,textarea{
    width:100%;padding:10px 12px;border:1px solid #cbd5e1;border-radius:10px;font:inherit
  }
  textarea{min-height:72px;resize:vertical}
  .row{display:flex;gap:8px;flex-wrap:wrap}
  .danger{background:#fecaca;color:#7f1d1d}
  .hint{color:#94a3b8;font-size:12px;margin:6px 2px 0}
  .spacer{height:8px}
  .export{display:flex;gap:8px;align-items:center;margin-top:8px}
  .export textarea{font-family:ui-monospace,SFMono-Regular,Menlo,Monaco,Consolas,monospace;min-height:120px}
  .pill{display:inline-block;padding:6px 10px;border-radius:999px;background:#f1f5f9;font-size:12px}
  .right{margin-left:auto}
  .small{font-size:12px}
  .kbd{font-family:ui-monospace,monospace;background:#0f172a;color:#fff;padding:2px 6px;border-radius:6px}

  /* Модалка */
  .modal[hidden]{display:none}
  .modal{position:fixed;inset:0;background:rgba(0,0,0,.6);display:grid;place-items:center;z-index:30}
  .modal__box{background:#fff;max-width:560px;margin:16px;padding:24px;border-radius:16px;text-align:center}
</style>
</head>
<body>
<div class="page">

  <!-- КАРТА -->
  <div class="card">
    <div class="toolbar">
      <label><input type="checkbox" id="editToggle"> Режим настройки зон</label>
      <span class="muted right">Подсказка: перетащите круг, потяните «усик» для изменения радиуса</span>
    </div>

    <div class="mapWrap" id="mapWrap">
      <!-- ВАЖНО: viewBox должен соответствовать реальному размеру 1.jpg. Здесь взят 768×1152. -->
      <svg id="svg" class="map" viewBox="0 0 768 1152" preserveAspectRatio="xMidYMid meet">
        <image id="mapImg" href="1.jpg" width="768" height="1152"/>

        <!-- Слои для зон (создаются из JS на основе массива zones) -->
        <g id="zonesLayer"></g>
      </svg>
    </div>
    <div class="muted" style="padding:8px 12px 14px">Координаты в системе <code>viewBox</code> (768×1152). При смене карты следите, чтобы размеры совпадали.</div>
  </div>

  <!-- ПАНЕЛЬ НАСТРОЙКИ -->
  <div class="panel">
    <h3>Настройки выбранной зоны</h3>

    <div class="row">
      <span class="pill" id="selectedName">—</span>
      <span class="pill">ID: <span id="selectedId">—</span></span>
      <button id="btnAdd" class="btn small right">+ Добавить зону</button>
    </div>

    <div class="field">
      <label for="zoneName">Название зоны</label>
      <select id="zoneName">
        <option>Скала пропитания</option>
        <option>Плато азарта</option>
        <option>Бухта тренировок</option>
        <option>Зона прибытия</option>
        <option>Устье разума</option>
        <option>Совет племени</option>
        <option>Лес вдохновения</option>
        <option>Лагерь красных</option>
        <option>Лагерь жёлтых</option>
      </select>
    </div>

    <div class="field inline">
      <div><label for="cx">X (cx)</label><input type="number" id="cx" step="1"></div>
      <div><label for="cy">Y (cy)</label><input type="number" id="cy" step="1"></div>
    </div>
    <div class="field">
      <label for="r">Радиус (r)</label>
      <input type="range" id="rRange" min="20" max="200" step="1">
      <input type="number" id="r" step="1">
    </div>

    <div class="field">
      <label for="type">Действие при клике</label>
      <select id="type">
        <option value="link">Открыть ссылку</option>
        <option value="message">Показать сообщение</option>
      </select>
    </div>

    <div class="field" id="linkField">
      <label for="link">Ссылка (откроется после смены картинки)</label>
      <input type="text" id="link" placeholder="https://...">
      <label class="small"><input type="checkbox" id="newtab"> Открыть в новой вкладке</label>
    </div>

    <div class="field" id="msgField" style="display:none">
      <label for="message">Сообщение для модалки</label>
      <textarea id="message" placeholder="Текст для всплывающего окна..."></textarea>
    </div>

    <div class="field">
      <label for="image">Изображение при клике</label>
      <select id="image">
        <option value="1.jpg">1.jpg — базовая карта (без подсветки)</option>
        <option value="2.jpg">2.jpg — Зона прибытия</option>
        <option value="3.jpg">3.jpg — Лес вдохновения</option>
        <option value="4.jpg">4.jpg — Совет племени</option>
        <option value="5.jpg">5.jpg — Бухта тренировок</option>
        <option value="6.jpg">6.jpg — Устье разума</option>
        <option value="7.jpg">7.jpg — Плато азарта</option>
        <option value="8.jpg">8.jpg — Скала пропитания</option>
      </select>
      <div class="hint">Эта картинка отобразится перед переходом по ссылке/перед показом сообщения.</div>
    </div>

    <div class="row">
      <button id="apply" class="btn">Применить</button>
      <button id="deleteZone" class="btn danger">Удалить зону</button>
    </div>

    <div class="spacer"></div>
    <h3>Экспорт / импорт</h3>
    <div class="export">
      <button id="btnExport" class="btn secondary">Скопировать JSON</button>
      <input type="file" id="fileImport" accept=".json" class="right">
    </div>
    <div class="field">
      <label>Текущая конфигурация зон (редактируйте и нажмите «Импорт из буфера»)</label>
      <textarea id="jsonArea" spellcheck="false"></textarea>
    </div>
    <div class="row">
      <button id="btnImportFromArea" class="btn secondary">Импорт из буфера</button>
      <span class="muted">Горячие клавиши: <span class="kbd">E</span> — вкл/выкл настройку</span>
    </div>
  </div>
</div>

<!-- Модалка -->
<div id="modal" class="modal" hidden>
  <div class="modal__box">
    <div id="modalText" style="margin-bottom:16px;font-size:18px;line-height:1.4">Сообщение…</div>
    <button class="btn" id="modalClose">Понятно</button>
  </div>
</div>

<script>
/* ---------- ИСХОДНЫЕ ЗОНЫ (можно править вручную) ---------- */
let zones = [
  {id:'food_cliff',   name:'Скала пропитания', cx:384, cy:160, r:90,  type:'link',    link:'#', image:'8.jpg', newtab:false},
  {id:'luck_plateau', name:'Плато азарта',     cx:600, cy:420, r:90,  type:'link',    link:'#', image:'7.jpg', newtab:false},
  {id:'workout_bay',  name:'Бухта тренировок', cx:165, cy:450, r:92,  type:'link',    link:'#', image:'5.jpg', newtab:false},
  {id:'arrival',      name:'Зона прибытия',    cx:160, cy:940, r:95,  type:'link',    link:'#', image:'2.jpg', newtab:false},
  {id:'mind_mouth',   name:'Устье разума',     cx:390, cy:420, r:78,  type:'link',    link:'#', image:'6.jpg', newtab:false},
  {id:'tribe_council',name:'Совет племени',    cx:385, cy:610, r:90,  type:'link',    link:'#', image:'4.jpg', newtab:false},
  {id:'inspire_forest',name:'Лес вдохновения', cx:650, cy:690, r:95,  type:'link',    link:'#', image:'3.jpg', newtab:false},
  {id:'camp_red',     name:'Лагерь красных',   cx:215, cy:790, r:95,  type:'message', message:'Тут будет сообщение для ЛАГЕРЯ КРАСНЫХ.', image:'1.jpg'},
  {id:'camp_yellow',  name:'Лагерь жёлтых',    cx:640, cy:900, r:95,  type:'message', message:'Тут будет сообщение для ЛАГЕРЯ ЖЁЛТЫХ.',  image:'1.jpg'}
];

/* ---------- ПРЕДЗАГРУЗКА КАРТИНОК ---------- */
['1.jpg','2.jpg','3.jpg','4.jpg','5.jpg','6.jpg','7.jpg','8.jpg'].forEach(s=>{const i=new Image(); i.src=s;});

/* ---------- ССЫЛКИ НА DOM ---------- */
const svg       = document.getElementById('svg');
const layer     = document.getElementById('zonesLayer');
const mapImg    = document.getElementById('mapImg');
const editToggle= document.getElementById('editToggle');
const modal     = document.getElementById('modal');
const modalText = document.getElementById('modalText');
const modalClose= document.getElementById('modalClose');

/* Панель */
const selectedName = document.getElementById('selectedName');
const selectedId   = document.getElementById('selectedId');
const zoneName = document.getElementById('zoneName');
const cxInput  = document.getElementById('cx');
const cyInput  = document.getElementById('cy');
const rInput   = document.getElementById('r');
const rRange   = document.getElementById('rRange');
const typeSel  = document.getElementById('type');
const linkField= document.getElementById('linkField');
const msgField = document.getElementById('msgField');
const linkInput= document.getElementById('link');
const newtab   = document.getElementById('newtab');
const message  = document.getElementById('message');
const imageSel = document.getElementById('image');

const applyBtn   = document.getElementById('apply');
const delBtn     = document.getElementById('deleteZone');
const addBtn     = document.getElementById('btnAdd');

const jsonArea   = document.getElementById('jsonArea');
const btnExport  = document.getElementById('btnExport');
const fileImport = document.getElementById('fileImport');
const btnImportFromArea = document.getElementById('btnImportFromArea');

/* ---------- РЕНДЕР ЗОН ---------- */
let selected = null;     // id выбранной зоны
let editing  = false;    // режим настройки
let busy     = false;    // защита от повторного клика

function renderZones(){
  layer.innerHTML = '';
  zones.forEach(z=>{
    // контур
    const outline = document.createElementNS('http://www.w3.org/2000/svg','circle');
    outline.setAttribute('class','zone-outline');
    outline.setAttribute('cx',z.cx); outline.setAttribute('cy',z.cy); outline.setAttribute('r',z.r);
    layer.appendChild(outline);

    // кликабельная зона (прозрачная)
    const c = document.createElementNS('http://www.w3.org/2000/svg','circle');
    c.setAttribute('class','hotspot');
    c.dataset.id=z.id;
    c.setAttribute('cx',z.cx); c.setAttribute('cy',z.cy); c.setAttribute('r',z.r);
    layer.appendChild(c);

    // ручка для изменения радиуса
    const handle = document.createElementNS('http://www.w3.org/2000/svg','circle');
    handle.setAttribute('class','handle');
    handle.dataset.id=z.id;
    handle.setAttribute('cx',z.cx + z.r);
    handle.setAttribute('cy',z.cy);
    handle.setAttribute('r',8);
    layer.appendChild(handle);

    // подпись
    const label = document.createElementNS('http://www.w3.org/2000/svg','text');
    label.setAttribute('class','zone-label');
    label.dataset.id=z.id;
    label.setAttribute('x',z.cx);
    label.setAttribute('y',z.cy - z.r - 10);
    label.setAttribute('text-anchor','middle');
    label.textContent = z.name;
    layer.appendChild(label);
  });
}
renderZones();

/* ---------- ВЫБОР ЗОНЫ ДЛЯ РЕДАКТИРОВАНИЯ ---------- */
function selectZone(id){
  selected = id;
  const z = zones.find(q=>q.id===id);
  if(!z) return;
  selectedName.textContent = z.name;
  selectedId.textContent   = z.id;
  zoneName.value = z.name;
  cxInput.value = z.cx; cyInput.value = z.cy;
  rInput.value = z.r; rRange.value = z.r;
  typeSel.value = z.type;
  linkInput.value = z.link || '';
  newtab.checked = !!z.newtab;
  message.value  = z.message || '';
  imageSel.value = z.image || '1.jpg';
  toggleActionFields();
}
function toggleActionFields(){
  const isMsg = typeSel.value==='message';
  msgField.style.display  = isMsg ? '' : 'none';
  linkField.style.display = isMsg ? 'none' : '';
}

/* Автовыбор первой зоны */
selectZone(zones[0].id);

/* ---------- ПЕРЕКЛЮЧЕНИЕ РЕЖИМА НАСТРОЙКИ ---------- */
function setEditing(v){
  editing = v;
  svg.classList.toggle('editing', editing);
}
editToggle.addEventListener('change', e => setEditing(e.target.checked));
document.addEventListener('keydown',e=>{
  if(e.key.toLowerCase()==='e'){ editToggle.checked=!editToggle.checked; setEditing(editToggle.checked); }
});

/* ---------- ПЕРЕТАСКИВАНИЕ И РЕСАЙЗ ---------- */
let drag = null; // {id, dx, dy}
let resize = null;// {id}

function getSVGPoint(evt){
  const pt = svg.createSVGPoint();
  pt.x = evt.clientX; pt.y = evt.clientY;
  return pt.matrixTransform(svg.getScreenCTM().inverse());
}
layer.addEventListener('pointerdown', (e)=>{
  const t = e.target;
  const id = t.dataset.id;
  if(!id) return;

  // клик по зоне в обычном режиме
  if(!editing && t.classList.contains('hotspot')){
    const z = zones.find(q=>q.id===id);
    if (!z || busy) return;
    busy = true;
    const swap = z.image || '1.jpg';
    mapImg.setAttribute('href', swap);

    if(z.type==='message'){
      setTimeout(()=>{ modalText.textContent = z.message || 'Сообщение'; modal.hidden=false; }, 250);
      return;
    }
    const doNav = z.link && z.link !== '#';
    if(doNav){
      setTimeout(()=>{
        if(z.newtab) window.open(z.link,'_blank'); else window.location.href=z.link;
      }, 700);
    }else{
      setTimeout(()=>{ mapImg.setAttribute('href','1.jpg'); busy=false; }, 900);
    }
    return;
  }

  // выбор зоны в режиме редактирования
  if(editing && t.classList.contains('hotspot')){
    selectZone(id);
    const p = getSVGPoint(e);
    const z = zones.find(q=>q.id===id);
    drag = {id, dx:p.x - z.cx, dy:p.y - z.cy};
    svg.setPointerCapture(e.pointerId);
  }

  // ресайз
  if(editing && t.classList.contains('handle')){
    selectZone(id);
    resize = {id};
    svg.setPointerCapture(e.pointerId);
  }
});

layer.addEventListener('pointermove', (e)=>{
  if(!(drag||resize)) return;
  const p = getSVGPoint(e);
  const z = zones.find(q=>q.id === (drag?drag.id:resize.id));
  if(!z) return;

  if(drag){
    z.cx = Math.max(0, Math.min(768, p.x - drag.dx));
    z.cy = Math.max(0, Math.min(1152, p.y - drag.dy));
  }
  if(resize){
    const dx = p.x - z.cx, dy = p.y - z.cy;
    z.r = Math.max(20, Math.min(220, Math.hypot(dx,dy)));
  }
  // обновить UI + перерисовать один раз «на лету»
  cxInput.value = Math.round(z.cx); cyInput.value = Math.round(z.cy);
  rInput.value = Math.round(z.r); rRange.value = Math.round(z.r);
  redrawSingle(z);
});

layer.addEventListener('pointerup', (e)=>{ drag=null; resize=null; svg.releasePointerCapture(e.pointerId); });

function redrawSingle(z){
  const sel = `[data-id="${z.id}"]`;
  const c   = layer.querySelector(`.hotspot${sel}`);
  const h   = layer.querySelector(`.handle${sel}`);
  const lab = layer.querySelector(`.zone-label${sel}`);
  const out = layer.querySelector(`.zone-outline + .hotspot${sel}`) ? null : null; // not used
  // обновляем
  c.setAttribute('cx',z.cx); c.setAttribute('cy',z.cy); c.setAttribute('r',z.r);
  const outline = Array.from(layer.querySelectorAll('.zone-outline'))[zones.findIndex(q=>q.id===z.id)];
  outline.setAttribute('cx',z.cx); outline.setAttribute('cy',z.cy); outline.setAttribute('r',z.r);
  h.setAttribute('cx', z.cx + z.r); h.setAttribute('cy', z.cy);
  lab.setAttribute('x', z.cx); lab.setAttribute('y', z.cy - z.r - 10); lab.textContent = z.name;
}

/* ---------- ПРИМЕНИТЬ ИЗ ФОРМЫ ---------- */
function applyForm(){
  if(!selected) return;
  const z = zones.find(q=>q.id===selected);
  z.name   = zoneName.value;
  z.cx     = Number(cxInput.value||z.cx);
  z.cy     = Number(cyInput.value||z.cy);
  z.r      = Number(rInput.value||z.r);
  z.type   = typeSel.value;
  z.link   = linkInput.value.trim();
  z.newtab = !!newtab.checked;
  z.message= message.value.trim();
  z.image  = imageSel.value;
  renderZones();
  selectZone(z.id);
}
applyBtn.addEventListener('click', applyForm);
zoneName.addEventListener('change', applyForm);
[typeSel, rRange].forEach(el=>el.addEventListener('input', ()=>{ if(el===rRange){ rInput.value=rRange.value; } toggleActionFields(); }));
rInput.addEventListener('input', ()=>{ rRange.value=rInput.value; });

/* ---------- ДОБАВИТЬ/УДАЛИТЬ ЗОНУ ---------- */
addBtn.addEventListener('click', ()=>{
  const id = 'zone_' + Math.random().toString(36).slice(2,7);
  const z = {id, name:'Новая зона', cx:384, cy:576, r:80, type:'link', link:'#', image:'1.jpg', newtab:false};
  zones.push(z);
  renderZones(); selectZone(z.id);
});
delBtn.addEventListener('click', ()=>{
  if(!selected) return;
  const i = zones.findIndex(z=>z.id===selected);
  if(i>-1){ zones.splice(i,1); renderZones(); if(zones[0]) selectZone(zones[0].id); }
});

/* ---------- ЭКСПОРТ/ИМПОРТ ---------- */
function refreshJSON(){
  jsonArea.value = JSON.stringify(zones, null, 2);
}
refreshJSON();

btnExport.addEventListener('click', async ()=>{
  refreshJSON();
  try{
    await navigator.clipboard.writeText(jsonArea.value);
    btnExport.textContent='Скопировано!'; setTimeout(()=>btnExport.textContent='Скопировать JSON',1200);
  }catch(e){ alert('Скопируйте вручную из поля ниже.'); }
});
fileImport.addEventListener('change', async (e)=>{
  const file = e.target.files?.[0]; if(!file) return;
  const text = await file.text();
  try{
    zones = JSON.parse(text);
    renderZones(); selectZone(zones[0]?.id); refreshJSON();
  }catch(err){ alert('Не удалось прочитать JSON'); }
});
btnImportFromArea.addEventListener('click', ()=>{
  try{
    const data = JSON.parse(jsonArea.value);
    zones = data; renderZones(); selectZone(zones[0]?.id); refreshJSON();
  }catch(err){ alert('Некорректный JSON'); }
});

/* ---------- МОДАЛКА ---------- */
function closeModal(){ modal.hidden=true; mapImg.setAttribute('href','1.jpg'); busy=false; }
modal.addEventListener('click',e=>{ if(e.target===modal) closeModal(); });
modalClose.addEventListener('click', closeModal);
document.addEventListener('keydown',e=>{ if(e.key==='Escape' && !modal.hidden) closeModal(); });
</script>
</body>
  </html>
