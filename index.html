<!DOCTYPE html>
<html lang="ru">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>Остров — кликабельные зоны (редактор 2.0)</title>

<!-- Карта и версии с индикаторами -->
<link rel="preload" as="image" href="1.jpg">
<link rel="preload" as="image" href="2.jpg">
<link rel="preload" as="image" href="3.jpg">
<link rel="preload" as="image" href="4.jpg">
<link rel="preload" as="image" href="5.jpg">
<link rel="preload" as="image" href="6.jpg">
<link rel="preload" as="image" href="7.jpg">
<link rel="preload" as="image" href="8.jpg">

<style>
  :root{--accent:#0ea5e9;--bg:#0e2230}
  *{box-sizing:border-box}
  body{margin:0;font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif;background:var(--bg)}
  .page{max-width:1100px;margin:0 auto;padding:16px;display:grid;gap:16px}
  @media(min-width:980px){.page{grid-template-columns:1fr 360px}}
  .card{background:#fff;border-radius:16px;box-shadow:0 10px 30px rgba(0,0,0,.15);overflow:hidden}
  .toolbar{display:flex;flex-wrap:wrap;gap:10px;align-items:center;padding:10px 12px;border-bottom:1px solid #e5e7eb;background:#fafafa}
  .toolbar label{display:inline-flex;align-items:center;gap:8px;font-weight:600}
  .right{margin-left:auto}
  .muted{font-size:12px;color:#64748b}
  .btn{appearance:none;border:0;border-radius:12px;padding:10px 14px;font-weight:700;cursor:pointer;background:var(--accent);color:#fff}

  .mapWrap{position:relative}
  .editing .mapWrap{touch-action:none} /* чтобы страница не скроллилась при перетаскивании на мобильных */
  .map{display:block;width:100%;height:auto}

  /* Зоны */
  .hotspot{cursor:pointer;pointer-events:all;fill:rgba(255,165,0,0)}
  /* В режиме редактирования сама зона НЕ ловит события — только ручки и контур */
  .editing .hotspot{pointer-events:none;fill:rgba(255,165,0,.10)}

  .zone-outline{display:none;stroke:var(--accent);stroke-width:2;stroke-dasharray:6 6;fill:none;pointer-events:stroke;cursor:pointer}
  .editing .zone-outline{display:block}

  .move-handle,.radius-handle{display:none;stroke:var(--accent);stroke-width:2}
  .editing .move-handle,.editing .radius-handle{display:block}
  .move-handle{fill:#fff;cursor:grab}
  .move-handle:active{cursor:grabbing}
  .radius-handle{fill:#fff;cursor:nesw-resize}

  .zone-label{display:none;font:700 12px/1 sans-serif;fill:#111}
  .editing .zone-label{display:block}

  .panel{background:#fff;border-radius:16px;box-shadow:0 10px 30px rgba(0,0,0,.15);padding:14px}
  .panel h3{margin:4px 0 10px}
  .field{display:grid;gap:6px;margin:8px 0}
  .inline{grid-template-columns:1fr 1fr;gap:8px}
  input[type="text"],input[type="number"],select,textarea{width:100%;padding:10px 12px;border:1px solid #cbd5e1;border-radius:10px;font:inherit}
  textarea{min-height:72px;resize:vertical}
  .pill{display:inline-block;padding:6px 10px;border-radius:999px;background:#f1f5f9;font-size:12px}
  .export{display:flex;gap:8px;align-items:center;margin-top:8px}
  .kbd{font-family:ui-monospace,monospace;background:#0f172a;color:#fff;padding:2px 6px;border-radius:6px}
  .danger{background:#fecaca;color:#7f1d1d}
  .small{font-size:12px}
</style>
</head>
<body>
<div class="page">

  <!-- КАРТА -->
  <div class="card">
    <div class="toolbar">
      <label><input type="checkbox" id="editToggle"> Режим настройки</label>
      <label><input type="checkbox" id="snapToggle"> Привязка к сетке</label>
      <label>Шаг: <input type="number" id="snapStep" value="8" min="1" style="width:70px"></label>
      <span class="muted right">Подсказка: тяните <span class="kbd">●</span> — двигаем, <span class="kbd">■</span> — радиус; стрелки — точная подгонка (Shift=×10)</span>
    </div>

    <div class="mapWrap">
      <!-- Если 1.jpg другого размера — замените размеры viewBox -->
      <svg id="svg" class="map" viewBox="0 0 768 1152" preserveAspectRatio="xMidYMid meet">
        <image id="mapImg" href="1.jpg" width="768" height="1152"/>
        <g id="zonesLayer"></g>
      </svg>
    </div>
  </div>

  <!-- ПАНЕЛЬ -->
  <div class="panel">
    <h3>Зона</h3>
    <div class="field">
      <span class="pill">ID: <span id="selId">—</span></span>
      <span class="pill">Название: <span id="selName">—</span></span>
    </div>

    <div class="field">
      <label for="nameSel">Название</label>
      <select id="nameSel">
        <option>Скала пропитания</option>
        <option>Плато азарта</option>
        <option>Бухта тренировок</option>
        <option>Зона прибытия</option>
        <option>Устье разума</option>
        <option>Совет племени</option>
        <option>Лес вдохновения</option>
        <option>Лагерь красных</option>
        <option>Лагерь жёлтых</option>
      </select>
    </div>

    <div class="field inline">
      <div><label>X (cx)</label><input type="number" id="cx"></div>
      <div><label>Y (cy)</label><input type="number" id="cy"></div>
    </div>
    <div class="field inline">
      <div><label>Радиус (r)</label><input type="number" id="r" min="20" max="220"></div>
      <div><label>Картинка</label>
        <select id="imageSel">
          <option>1.jpg</option><option>2.jpg</option><option>3.jpg</option><option>4.jpg</option>
          <option>5.jpg</option><option>6.jpg</option><option>7.jpg</option><option>8.jpg</option>
        </select>
      </div>
    </div>

    <div class="field">
      <label>Действие</label>
      <select id="action">
        <option value="link">Открыть ссылку</option>
        <option value="message">Показать сообщение</option>
      </select>
    </div>

    <div class="field" id="linkBox">
      <label>Ссылка</label>
      <input type="text" id="link" placeholder="https://...">
      <label class="small"><input type="checkbox" id="newtab"> Открывать в новой вкладке</label>
    </div>

    <div class="field" id="msgBox" style="display:none">
      <label>Сообщение</label>
      <textarea id="message" placeholder="Текст модалки"></textarea>
    </div>

    <div class="field">
      <button id="apply" class="btn">Применить</button>
      <button id="add" class="btn small" style="margin-left:8px">+ Добавить зону</button>
      <button id="remove" class="btn danger small" style="margin-left:8px">Удалить</button>
    </div>

    <h3>Экспорт / импорт</h3>
    <div class="export">
      <button id="exportBtn" class="btn">Скопировать JSON</button>
      <input type="file" id="importFile" accept=".json" class="right">
    </div>
    <div class="field">
      <textarea id="jsonArea" spellcheck="false"></textarea>
    </div>
    <div class="field">
      <button id="importArea" class="btn">Импорт из поля</button>
    </div>
  </div>
</div>

<!-- Модалка -->
<div id="modal" style="position:fixed;inset:0;background:rgba(0,0,0,.6);display:none;place-items:center;z-index:30">
  <div style="background:#fff;max-width:560px;margin:16px;padding:24px;border-radius:16px;text-align:center">
    <div id="modalText" style="margin-bottom:16px;font-size:18px;line-height:1.4">Сообщение…</div>
    <button id="modalClose" class="btn">Понятно</button>
  </div>
</div>

<script>
/* --- ИСХОДНЫЕ ЗОНЫ --- */
let zones = [
  {id:'food_cliff',   name:'Скала пропитания', cx:384, cy:160, r:90,  type:'link',    link:'#', image:'8.jpg', newtab:false},
  {id:'luck_plateau', name:'Плато азарта',     cx:600, cy:420, r:90,  type:'link',    link:'#', image:'7.jpg', newtab:false},
  {id:'workout_bay',  name:'Бухта тренировок', cx:165, cy:450, r:92,  type:'link',    link:'#', image:'5.jpg', newtab:false},
  {id:'arrival',      name:'Зона прибытия',    cx:160, cy:940, r:95,  type:'link',    link:'#', image:'2.jpg', newtab:false},
  {id:'mind_mouth',   name:'Устье разума',     cx:390, cy:420, r:78,  type:'link',    link:'#', image:'6.jpg', newtab:false},
  {id:'tribe_council',name:'Совет племени',    cx:385, cy:610, r:90,  type:'link',    link:'#', image:'4.jpg', newtab:false},
  {id:'inspire_forest',name:'Лес вдохновения', cx:650, cy:690, r:95,  type:'link',    link:'#', image:'3.jpg', newtab:false},
  {id:'camp_red',     name:'Лагерь красных',   cx:215, cy:790, r:95,  type:'message', message:'Тут будет сообщение для ЛАГЕРЯ КРАСНЫХ.', image:'1.jpg'},
  {id:'camp_yellow',  name:'Лагерь жёлтых',    cx:640, cy:900, r:95,  type:'message', message:'Тут будет сообщение для ЛАГЕРЯ ЖЁЛТЫХ.',  image:'1.jpg'}
];

/* --- ПРЕДЗАГРУЗКА --- */
['1.jpg','2.jpg','3.jpg','4.jpg','5.jpg','6.jpg','7.jpg','8.jpg'].forEach(s=>{const i=new Image(); i.src=s;});

/* --- DOM --- */
const svg=document.getElementById('svg');
const layer=document.getElementById('zonesLayer');
const mapImg=document.getElementById('mapImg');
const editToggle=document.getElementById('editToggle');
const snapToggle=document.getElementById('snapToggle');
const snapStep=document.getElementById('snapStep');

const selId=document.getElementById('selId');
const selName=document.getElementById('selName');
const nameSel=document.getElementById('nameSel');
const cxIn=document.getElementById('cx');
const cyIn=document.getElementById('cy');
const rIn=document.getElementById('r');
const imageSel=document.getElementById('imageSel');
const actionSel=document.getElementById('action');
const linkBox=document.getElementById('linkBox');
const msgBox=document.getElementById('msgBox');
const linkIn=document.getElementById('link');
const newtab=document.getElementById('newtab');
const messageIn=document.getElementById('message');

const applyBtn=document.getElementById('apply');
const addBtn=document.getElementById('add');
const removeBtn=document.getElementById('remove');

const exportBtn=document.getElementById('exportBtn');
const importFile=document.getElementById('importFile');
const jsonArea=document.getElementById('jsonArea');
const importArea=document.getElementById('importArea');

const modal=document.getElementById('modal');
const modalText=document.getElementById('modalText');
const modalClose=document.getElementById('modalClose');

/* --- РЕНДЕР --- */
let selected = zones[0].id;
let editing=false, busy=false;

function render(){
  layer.innerHTML='';
  zones.forEach(z=>{
    // контур
    const outline = document.createElementNS('http://www.w3.org/2000/svg','circle');
    outline.setAttribute('class','zone-outline');
    outline.dataset.id=z.id;
    outline.setAttribute('cx',z.cx); outline.setAttribute('cy',z.cy); outline.setAttribute('r',z.r);
    layer.appendChild(outline);

    // кликабельная зона (для обычного режима)
    const c = document.createElementNS('http://www.w3.org/2000/svg','circle');
    c.setAttribute('class','hotspot');
    c.dataset.id=z.id;
    c.setAttribute('cx',z.cx); c.setAttribute('cy',z.cy); c.setAttribute('r',z.r);
    layer.appendChild(c);

    // центр-ручка (движение)
    const move = document.createElementNS('http://www.w3.org/2000/svg','circle');
    move.setAttribute('class','move-handle');
    move.dataset.id=z.id;
    move.setAttribute('cx',z.cx); move.setAttribute('cy',z.cy); move.setAttribute('r',10);
    layer.appendChild(move);

    // ручка радиуса (квадрат)
    const rh = document.createElementNS('http://www.w3.org/2000/svg','rect');
    rh.setAttribute('class','radius-handle');
    rh.dataset.id=z.id;
    rh.setAttribute('x', z.cx + z.r - 7); rh.setAttribute('y', z.cy - 7); rh.setAttribute('width',14); rh.setAttribute('height',14);
    layer.appendChild(rh);

    // подпись
    const label = document.createElementNS('http://www.w3.org/2000/svg','text');
    label.setAttribute('class','zone-label');
    label.dataset.id=z.id;
    label.setAttribute('x',z.cx); label.setAttribute('y',z.cy - z.r - 10);
    label.setAttribute('text-anchor','middle');
    label.textContent=z.name;
    layer.appendChild(label);
  });
  refreshForm();
  jsonArea.value = JSON.stringify(zones,null,2);
}
render();

function refreshForm(){
  const z = zones.find(q=>q.id===selected) || zones[0];
  if(!z) return;
  selId.textContent=z.id; selName.textContent=z.name;
  nameSel.value=z.name; cxIn.value=Math.round(z.cx); cyIn.value=Math.round(z.cy); rIn.value=Math.round(z.r);
  imageSel.value=z.image || '1.jpg';
  actionSel.value=z.type; linkIn.value=z.link||''; newtab.checked=!!z.newtab; messageIn.value=z.message||'';
  linkBox.style.display = z.type==='link' ? '' : 'none';
  msgBox.style.display  = z.type==='message' ? '' : 'none';
}

/* --- РЕЖИМ --- */
function setEditing(v){ editing=v; svg.classList.toggle('editing',editing); }
editToggle.addEventListener('change',e=>setEditing(e.target.checked));

/* --- Навигация/клики в обычном режиме --- */
layer.addEventListener('click', (e)=>{
  if(editing) return;
  const id=e.target.dataset.id; if(!id) return;
  const z=zones.find(q=>q.id===id); if(!z||busy) return;
  busy=true; mapImg.setAttribute('href', z.image||'1.jpg');

  if(z.type==='message'){
    setTimeout(()=>{ modalText.textContent=z.message||'Сообщение'; modal.style.display='grid'; }, 250);
    return;
  }
  if(z.link && z.link!=='#'){
    setTimeout(()=>{ z.newtab?window.open(z.link,'_blank'):window.location.assign(z.link); }, 700);
  }else{
    setTimeout(()=>{ mapImg.setAttribute('href','1.jpg'); busy=false; }, 900);
  }
});

/* --- Выбор, перетаскивание и ресайз (только ручки/контур) --- */
function svgPoint(evt){
  const pt=svg.createSVGPoint(); pt.x=evt.clientX; pt.y=evt.clientY;
  return pt.matrixTransform(svg.getScreenCTM().inverse());
}
let drag=null, resize=null, startP=null, startZ=null;

layer.addEventListener('pointerdown',e=>{
  if(!editing) return;
  const t=e.target;
  const id=t.dataset.id;
  if(!id) return;

  selected=id; refreshForm();

  if(t.classList.contains('move-handle') || t.classList.contains('zone-outline')){
    startP=svgPoint(e); startZ={...zones.find(z=>z.id===id)};
    drag={id}; svg.setPointerCapture(e.pointerId);
  }
  if(t.classList.contains('radius-handle')){
    startP=svgPoint(e); startZ={...zones.find(z=>z.id===id)};
    resize={id}; svg.setPointerCapture(e.pointerId);
  }
});

layer.addEventListener('pointermove',e=>{
  if(!(drag||resize)) return;
  const p=svgPoint(e);
  const z=zones.find(q=>q.id===((drag||resize).id));
  if(!z) return;

  if(drag){
    const dx=p.x-startP.x, dy=p.y-startP.y;
    z.cx=startZ.cx+dx; z.cy=startZ.cy+dy;
    if(snapToggle.checked){ const s=Math.max(1,Number(snapStep.value||8)); z.cx=Math.round(z.cx/s)*s; z.cy=Math.round(z.cy/s)*s; }
  }
  if(resize){
    const dx=p.x-startZ.cx, dy=p.y-startZ.cy;
    z.r=Math.max(20,Math.min(220, Math.hypot(dx,dy)));
    if(snapToggle.checked){ const s=Math.max(1,Number(snapStep.value||8)); z.r=Math.round(z.r/s)*s; }
  }
  redraw(z);
});

layer.addEventListener('pointerup',e=>{
  if(drag||resize){ svg.releasePointerCapture(e.pointerId); drag=resize=startP=startZ=null; jsonArea.value=JSON.stringify(zones,null,2); refreshForm(); }
});

function redraw(z){
  // контур
  const outline=[...layer.querySelectorAll('.zone-outline')][zones.findIndex(q=>q.id===z.id)];
  outline.setAttribute('cx',z.cx); outline.setAttribute('cy',z.cy); outline.setAttribute('r',z.r);
  // зона
  const c=layer.querySelector(`.hotspot[data-id="${z.id}"]`);
  c.setAttribute('cx',z.cx); c.setAttribute('cy',z.cy); c.setAttribute('r',z.r);
  // move-handle
  const mh=layer.querySelector(`.move-handle[data-id="${z.id}"]`);
  mh.setAttribute('cx',z.cx); mh.setAttribute('cy',z.cy);
  // radius-handle
  const rh=layer.querySelector(`.radius-handle[data-id="${z.id}"]`);
  rh.setAttribute('x', z.cx+z.r-7); rh.setAttribute('y', z.cy-7);
  // подпись
  const lab=layer.querySelector(`.zone-label[data-id="${z.id}"]`);
  lab.setAttribute('x',z.cx); lab.setAttribute('y',z.cy-z.r-10); lab.textContent=z.name;
}

/* --- Тонкая подгонка стрелками --- */
document.addEventListener('keydown',e=>{
  if(!editing) return;
  const z=zones.find(q=>q.id===selected); if(!z) return;
  const step = e.shiftKey ? 10 : 1;
  if(['ArrowLeft','ArrowRight','ArrowUp','ArrowDown'].includes(e.key)){ e.preventDefault(); }
  if(e.key==='ArrowLeft')  z.cx-=step;
  if(e.key==='ArrowRight') z.cx+=step;
  if(e.key==='ArrowUp')    z.cy-=step;
  if(e.key==='ArrowDown')  z.cy+=step;
  if(e.key==='-')          z.r=Math.max(20, z.r-1);
  if(e.key==='=')          z.r=Math.min(220, z.r+1);
  if(['ArrowLeft','ArrowRight','ArrowUp','ArrowDown','-','='].includes(e.key)){
    if(snapToggle.checked){ const s=Math.max(1,Number(snapStep.value||8)); z.cx=Math.round(z.cx/s)*s; z.cy=Math.round(z.cy/s)*s; }
    redraw(z); refreshForm(); jsonArea.value=JSON.stringify(zones,null,2);
  }
});

/* --- ФОРМА --- */
function apply(){
  const z=zones.find(q=>q.id===selected); if(!z) return;
  z.name=nameSel.value;
  z.cx=Number(cxIn.value||z.cx);
  z.cy=Number(cyIn.value||z.cy);
  z.r =Number(rIn.value ||z.r);
  z.image=imageSel.value;
  z.type=actionSel.value;
  z.link=linkIn.value.trim();
  z.newtab=!!newtab.checked;
  z.message=messageIn.value.trim();
  redraw(z); refreshForm(); jsonArea.value=JSON.stringify(zones,null,2);
}
applyBtn.addEventListener('click',apply);
[actionSel].forEach(el=>el.addEventListener('change',refreshForm));
[nameSel,cxIn,cyIn,rIn,imageSel,linkIn,newtab,messageIn].forEach(el=>el.addEventListener('change',apply));

/* --- Добавить/Удалить --- */
addBtn.addEventListener('click',()=>{
  const id='zone_'+Math.random().toString(36).slice(2,7);
  const z={id,name:'Новая зона',cx:384,cy:576,r:80,type:'link',link:'#',image:'1.jpg',newtab:false};
  zones.push(z); render(); selected=id; refreshForm();
});
removeBtn.addEventListener('click',()=>{
  const i=zones.findIndex(z=>z.id===selected);
  if(i>-1){ zones.splice(i,1); render(); selected=zones[0]?.id; refreshForm(); }
});

/* --- Экспорт/Импорт --- */
exportBtn.addEventListener('click',async()=>{
  const txt=JSON.stringify(zones,null,2);
  jsonArea.value=txt;
  try{ await navigator.clipboard.writeText(txt); exportBtn.textContent='Скопировано!'; setTimeout(()=>exportBtn.textContent='Скопировать JSON',1200); }catch{}
});
importFile.addEventListener('change',async(e)=>{
  const f=e.target.files?.[0]; if(!f) return;
  try{ zones=JSON.parse(await f.text()); render(); }catch{ alert('Некорректный JSON'); }
});
importArea.addEventListener('click',()=>{
  try{ zones=JSON.parse(jsonArea.value); render(); }catch{ alert('Некорректный JSON'); }
});

/* --- Модалка --- */
function closeModal(){ modal.style.display='none'; mapImg.setAttribute('href','1.jpg'); busy=false; }
modalClose.addEventListener('click',closeModal);
modal.addEventListener('click',e=>{ if(e.target===modal) closeModal(); });
</script>
</body>
</html>
