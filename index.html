<!DOCTYPE html>
<html lang="ru">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>–û—Å—Ç—Ä–æ–≤ ‚Äî –∫—Ä—É–≥–æ–≤—ã–µ –∑–æ–Ω—ã (–ø—Ä–∞–≤–∫–∏ –∫–æ–æ—Ä–¥–∏–Ω–∞—Ç, –±–µ–∑ –ø–æ–¥—Å–≤–µ—Ç–∫–∏)</title>

<!-- –ö–∞—Ä—Ç–∞ –∏ –≤–µ—Ä—Å–∏–∏ —Å –∏–Ω–¥–∏–∫–∞—Ç–æ—Ä–∞–º–∏ -->
<link rel="preload" as="image" href="1.jpg">
<link rel="preload" as="image" href="2.jpg">
<link rel="preload" as="image" href="3.jpg">
<link rel="preload" as="image" href="4.jpg">
<link rel="preload" as="image" href="5.jpg">
<link rel="preload" as="image" href="6.jpg">
<link rel="preload" as="image" href="7.jpg">
<link rel="preload" as="image" href="8.jpg">

<style>
  :root{--accent:#0ea5e9;--bg:#0e2230}
  *{box-sizing:border-box}
  body{margin:0;font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif;background:var(--bg)}
  .page{max-width:1100px;margin:0 auto;padding:16px;display:grid;gap:16px}
  @media(min-width:980px){.page{grid-template-columns:1fr 360px}}
  .card{background:#fff;border-radius:16px;box-shadow:0 10px 30px rgba(0,0,0,.15);overflow:hidden}
  .toolbar{display:flex;flex-wrap:wrap;gap:10px;align-items:center;padding:10px 12px;border-bottom:1px solid #e5e7eb;background:#fafafa}
  .toolbar label{display:inline-flex;align-items:center;gap:8px;font-weight:600}
  .right{margin-left:auto}
  .muted{font-size:12px;color:#64748b}
  .btn{appearance:none;border:0;border-radius:12px;padding:10px 14px;font-weight:700;cursor:pointer;background:var(--accent);color:#fff}

  .mapWrap{position:relative}
  .editing .mapWrap{touch-action:none} /* –±–µ–∑ —Å–∫—Ä–æ–ª–ª–∞ –ø—Ä–∏ –ø–µ—Ä–µ—Ç–∞—Å–∫–∏–≤–∞–Ω–∏–∏ –Ω–∞ –º–æ–±–∏–ª–∫–∞—Ö */
  .map{display:block;width:100%;height:auto}

  /* –ó–æ–Ω—ã ‚Äî –±–µ–∑ –ø–æ–¥—Å–≤–µ—Ç–∫–∏ –≤–æ–æ–±—â–µ */
  .hotspot{cursor:pointer;pointer-events:all;fill:rgba(255,165,0,0)}
  .editing .hotspot{pointer-events:none} /* –≤ —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏–∏ –∫–ª–∏–∫–∏ –ø–æ –∑–æ–Ω–µ –æ—Ç–∫–ª—é—á–µ–Ω—ã */

  .zone-outline{display:none;stroke:var(--accent);stroke-width:2;stroke-dasharray:6 6;fill:none;pointer-events:stroke;cursor:grab}
  .editing .zone-outline{display:block}
  .zone-outline:active{cursor:grabbing}

  .move-handle,.radius-handle{display:none;stroke:var(--accent);stroke-width:2}
  .editing .move-handle,.editing .radius-handle{display:block}
  .move-handle{fill:#fff;cursor:grab}
  .move-handle:active{cursor:grabbing}
  .radius-handle{fill:#fff;cursor:ew-resize} /* —Ç—è–Ω–µ–º —Ä–∞–¥–∏—É—Å –≤–ø—Ä–∞–≤–æ */

  .zone-label{display:none;font:700 12px/1 sans-serif;fill:#111}
  .editing .zone-label{display:block}

  .panel{background:#fff;border-radius:16px;box-shadow:0 10px 30px rgba(0,0,0,.15);padding:14px}
  .panel h3{margin:4px 0 10px}
  .field{display:grid;gap:6px;margin:8px 0}
  .inline{grid-template-columns:1fr 1fr;gap:8px}
  input[type="text"],input[type="number"],select,textarea{width:100%;padding:10px 12px;border:1px solid #cbd5e1;border-radius:10px;font:inherit}
  textarea{min-height:72px;resize:vertical}
  .pill{display:inline-block;padding:6px 10px;border-radius:999px;background:#f1f5f9;font-size:12px}
  .export{display:flex;gap:8px;align-items:center;margin-top:8px}
  .kbd{font-family:ui-monospace,monospace;background:#0f172a;color:#fff;padding:2px 6px;border-radius:6px}
  .danger{background:#fecaca;color:#7f1d1d}
  .small{font-size:12px}
</style>
</head>
<body>
<div class="page">

  <!-- –ö–ê–†–¢–ê -->
  <div class="card">
    <div class="toolbar">
      <label><input type="checkbox" id="editToggle"> –†–µ–∂–∏–º –Ω–∞—Å—Ç—Ä–æ–π–∫–∏</label>
      <label><input type="checkbox" id="snapToggle"> –ü—Ä–∏–≤—è–∑–∫–∞ –∫ —Å–µ—Ç–∫–µ</label>
      <label>–®–∞–≥: <input type="number" id="snapStep" value="8" min="1" style="width:70px"></label>
      <span class="muted right">–¢—è–Ω–∏—Ç–µ <span class="kbd">‚óè</span> ‚Äî –¥–≤–∏–≥–∞–µ–º, <span class="kbd">‚ñ†</span> ‚Äî —Ä–∞–¥–∏—É—Å; —Å—Ç—Ä–µ–ª–∫–∏ ‚Äî —Ç–æ—á–Ω–∞—è –ø–æ–¥–≥–æ–Ω–∫–∞</span>
    </div>

    <div class="mapWrap">
      <!-- –ï—Å–ª–∏ 1.jpg –¥—Ä—É–≥–æ–≥–æ —Ä–∞–∑–º–µ—Ä–∞ ‚Äî –ø–æ–º–µ–Ω—è–π—Ç–µ viewBox -->
      <svg id="svg" class="map" viewBox="0 0 768 1152" preserveAspectRatio="xMidYMid meet">
        <image id="mapImg" href="1.jpg" width="768" height="1152"/>
        <g id="zonesLayer"></g>
      </svg>
    </div>
  </div>

  <!-- –ü–ê–ù–ï–õ–¨ -->
  <div class="panel">
    <h3>–ó–æ–Ω–∞</h3>
    <div class="field">
      <span class="pill">ID: <span id="selId">‚Äî</span></span>
      <span class="pill">–ù–∞–∑–≤–∞–Ω–∏–µ: <span id="selName">‚Äî</span></span>
    </div>

    <div class="field">
      <label for="nameSel">–ù–∞–∑–≤–∞–Ω–∏–µ</label>
      <select id="nameSel">
        <option>–°–∫–∞–ª–∞ –ø—Ä–æ–ø–∏—Ç–∞–Ω–∏—è</option>
        <option>–ü–ª–∞—Ç–æ –∞–∑–∞—Ä—Ç–∞</option>
        <option>–ë—É—Ö—Ç–∞ —Ç—Ä–µ–Ω–∏—Ä–æ–≤–æ–∫</option>
        <option>–ó–æ–Ω–∞ –ø—Ä–∏–±—ã—Ç–∏—è</option>
        <option>–£—Å—Ç—å–µ —Ä–∞–∑—É–º–∞</option>
        <option>–°–æ–≤–µ—Ç –ø–ª–µ–º–µ–Ω–∏</option>
        <option>–õ–µ—Å –≤–¥–æ—Ö–Ω–æ–≤–µ–Ω–∏—è</option>
        <option>–õ–∞–≥–µ—Ä—å –∫—Ä–∞—Å–Ω—ã—Ö</option>
        <option>–õ–∞–≥–µ—Ä—å –∂—ë–ª—Ç—ã—Ö</option>
      </select>
    </div>

    <div class="field inline">
      <div><label>X (cx)</label><input type="number" id="cx"></div>
      <div><label>Y (cy)</label><input type="number" id="cy"></div>
    </div>
    <div class="field inline">
      <div><label>–†–∞–¥–∏—É—Å (r)</label><input type="number" id="r" min="20" max="400"></div>
      <div><label>–ö–∞—Ä—Ç–∏–Ω–∫–∞</label>
        <select id="imageSel">
          <option>1.jpg</option><option>2.jpg</option><option>3.jpg</option><option>4.jpg</option>
          <option>5.jpg</option><option>6.jpg</option><option>7.jpg</option><option>8.jpg</option>
        </select>
      </div>
    </div>

    <div class="field">
      <label>–î–µ–π—Å—Ç–≤–∏–µ</label>
      <select id="action">
        <option value="link">–û—Ç–∫—Ä—ã—Ç—å —Å—Å—ã–ª–∫—É</option>
        <option value="message">–ü–æ–∫–∞–∑–∞—Ç—å —Å–æ–æ–±—â–µ–Ω–∏–µ</option>
      </select>
    </div>

    <div class="field" id="linkBox">
      <label>–°—Å—ã–ª–∫–∞</label>
      <input type="text" id="link" placeholder="https://...">
      <label class="small"><input type="checkbox" id="newtab"> –û—Ç–∫—Ä—ã–≤–∞—Ç—å –≤ –Ω–æ–≤–æ–π –≤–∫–ª–∞–¥–∫–µ</label>
    </div>
    <div class="field" id="msgBox" style="display:none">
      <label>–°–æ–æ–±—â–µ–Ω–∏–µ</label>
      <textarea id="message" placeholder="–¢–µ–∫—Å—Ç –º–æ–¥–∞–ª–∫–∏"></textarea>
    </div>

    <div class="field">
      <button id="apply" class="btn">–ü—Ä–∏–º–µ–Ω–∏—Ç—å</button>
      <button id="add" class="btn small" style="margin-left:8px">+ –î–æ–±–∞–≤–∏—Ç—å –∑–æ–Ω—É</button>
      <button id="remove" class="btn danger small" style="margin-left:8px">–£–¥–∞–ª–∏—Ç—å</button>
    </div>

    <h3>–≠–∫—Å–ø–æ—Ä—Ç / –∏–º–ø–æ—Ä—Ç</h3>
    <div class="export">
      <button id="exportBtn" class="btn">–°–∫–æ–ø–∏—Ä–æ–≤–∞—Ç—å JSON</button>
      <input type="file" id="importFile" accept=".json" class="right">
    </div>
    <div class="field">
      <textarea id="jsonArea" spellcheck="false"></textarea>
    </div>
    <div class="field">
      <button id="importArea" class="btn">–ò–º–ø–æ—Ä—Ç –∏–∑ –ø–æ–ª—è</button>
    </div>
  </div>
</div>

<!-- –ú–æ–¥–∞–ª–∫–∞ -->
<div id="modal" style="position:fixed;inset:0;background:rgba(0,0,0,.6);display:none;place-items:center;z-index:30">
  <div style="background:#fff;max-width:560px;margin:16px;padding:24px;border-radius:16px;text-align:center">
    <div id="modalText" style="margin-bottom:16px;font-size:18px;line-height:1.4">–°–æ–æ–±—â–µ–Ω–∏–µ‚Ä¶</div>
    <button id="modalClose" class="btn">–ü–æ–Ω—è—Ç–Ω–æ</button>
  </div>
</div>

<script>
/* --- –°–õ–£–ß–ê–ô–ù–´–ï –°–û–û–ë–©–ï–ù–ò–Ø –î–õ–Ø –õ–ê–ì–ï–†–ï–ô --- */
const MSG_RED = [
  'üî• –õ–∞–≥–µ—Ä—å –ö—Ä–∞—Å–Ω—ã—Ö –Ω–∞ —Å–≤—è–∑–∏! –°–æ–±–∏—Ä–∞–µ–º—Å—è –∏ –∂–∂—ë–º —Å–µ–≥–æ–¥–Ω—è—à–Ω–∏–µ —à–∞–≥–∏.',
  '–ü–ª–∞–º—è —Ä–∞–∑–≥–æ—Ä–µ–ª–æ—Å—å ‚Äî –ø–æ—Ä–∞ –≤ –ë—É—Ö—Ç—É —Ç—Ä–µ–Ω–∏—Ä–æ–≤–æ–∫.',
  '–ù–∞—à –¥–µ–≤–∏–∑: ¬´–ú–∞–ª–æ —Å–ª–æ–≤ ‚Äî –±–æ–ª—å—à–µ —à–∞–≥–æ–≤¬ª. –í –±–æ–π!',
  '–ì–æ—Ä—è—á–∏–π –∫–≤–µ—Å—Ç –¥–Ω—è: 10 –º–∏–Ω—É—Ç —Ç–µ–º–ø–æ–≤–æ–π —Ö–æ–¥—å–±—ã + –≤–æ–¥–∞. –°–¥–µ–ª–∞–Ω–æ?',
  '–¢–æ–ø–∏–º –ø—Ä–æ–∫—Ä–∞—Å—Ç–∏–Ω–∞—Ü–∏—é: 3‚Ä¶2‚Ä¶1 ‚Äî –ø–æ—à–ª–∏!',
  '–°–µ–≥–æ–¥–Ω—è –æ—Ö–æ—Ç–∞ –∑–∞ –æ—á–∫–∞–º–∏: –±–µ—Ä—ë–º –ª–∏–¥–µ—Ä—Å—Ç–≤–æ?'
];
const MSG_YELLOW = [
  'üåû –õ–∞–≥–µ—Ä—å –ñ—ë–ª—Ç—ã—Ö —Å–≤–µ—Ç–∏—Ç —è—Ä—á–µ! –í–∫–ª—é—á–∞–µ–º —ç–Ω–µ—Ä–≥–∏—é –∏ —à–∞–≥–∞–µ–º.',
  '–°–æ–ª–Ω—ã—à–∫–æ –∑–æ–≤—ë—Ç: ¬´+1000 —à–∞–≥–æ–≤ –¥–æ –æ–±–µ–¥–∞¬ª. –£—Å–ø–µ–µ–º?',
  '–ù–∞—à –¥–µ–≤–∏–∑: ¬´–õ–µ–≥–∫–æ, —Å–≤–µ—Ç–ª–æ, —Ä–µ–∑—É–ª—å—Ç–∞—Ç–Ω–æ¬ª. –ü–æ–µ—Ö–∞–ª–∏!',
  '–î–µ–Ω—å –ª—ë–≥–∫–æ—Å—Ç–∏: 15 –º–∏–Ω—É—Ç —à–∞–≥–æ–≤ + —Ä–∞—Å—Ç—è–∂–∫–∞.',
  '–£–ª—ã–±–∫–∞ + –º—É–∑—ã–∫–∞ = –±—ã—Å—Ç—Ä—ã–µ –∫–∞–ª–æ—Ä–∏–∏. –í–ø–µ—Ä—ë–¥!',
  '–î–µ—Ä–∂–∏–º –ª–∏–¥–µ—Ä—Å—Ç–≤–æ! –û—Å—Ç–∞–≤–∏–º –ö—Ä–∞—Å–Ω—ã—Ö –ø–æ–∑–∞–¥–∏?'
];
function randomFrom(arr){ return arr[Math.floor(Math.random()*arr.length)] }

/* --- –ò–°–•–û–î–ù–´–ï –ó–û–ù–´ (–∫—Ä—É–≥–∏) —Å —Ç–≤–æ–∏–º–∏ –∫–æ–æ—Ä–¥–∏–Ω–∞—Ç–∞–º–∏ --- */
let zones = [
  {id:'food_cliff',   name:'–°–∫–∞–ª–∞ –ø—Ä–æ–ø–∏—Ç–∞–Ω–∏—è', cx:384, cy:160, r:137, type:'link',    link:'#', image:'8.jpg', newtab:false},
  {id:'luck_plateau', name:'–ü–ª–∞—Ç–æ –∞–∑–∞—Ä—Ç–∞',     cx:621, cy:373, r:146, type:'link',    link:'#', image:'7.jpg', newtab:false},
  {id:'mind_mouth',   name:'–£—Å—Ç—å–µ —Ä–∞–∑—É–º–∞',     cx:423, cy:369, r: 68, type:'link',    link:'#', image:'6.jpg', newtab:false},
  {id:'workout_bay',  name:'–ë—É—Ö—Ç–∞ —Ç—Ä–µ–Ω–∏—Ä–æ–≤–æ–∫', cx:151, cy:491, r:112, type:'link',    link:'#', image:'5.jpg', newtab:false},
  {id:'tribe_council',name:'–°–æ–≤–µ—Ç –ø–ª–µ–º–µ–Ω–∏',    cx:384, cy:588, r: 98, type:'link',    link:'#', image:'4.jpg', newtab:false},
  {id:'inspire_forest',name:'–õ–µ—Å –≤–¥–æ—Ö–Ω–æ–≤–µ–Ω–∏—è', cx:625, cy:629, r:117, type:'link',    link:'#', image:'3.jpg', newtab:false},
  {id:'camp_yellow',  name:'–õ–∞–≥–µ—Ä—å –∂—ë–ª—Ç—ã—Ö',    cx:640, cy:900, r: 95, type:'message', message:'', image:'1.jpg'},
  {id:'camp_red',     name:'–õ–∞–≥–µ—Ä—å –∫—Ä–∞—Å–Ω—ã—Ö',   cx:187, cy:694, r: 95, type:'message', message:'', image:'1.jpg'},
  {id:'arrival',      name:'–ó–æ–Ω–∞ –ø—Ä–∏–±—ã—Ç–∏—è',    cx:165, cy:835, r: 69, type:'link',    link:'#', image:'2.jpg', newtab:false}
];

/* --- –ü–†–ï–î–ó–ê–ì–†–£–ó–ö–ê --- */
['1.jpg','2.jpg','3.jpg','4.jpg','5.jpg','6.jpg','7.jpg','8.jpg'].forEach(s=>{const i=new Image(); i.src=s;});

/* --- DOM --- */
const svg=document.getElementById('svg');
const layer=document.getElementById('zonesLayer');
const mapImg=document.getElementById('mapImg');
const editToggle=document.getElementById('editToggle');
const snapToggle=document.getElementById('snapToggle');
const snapStep=document.getElementById('snapStep');

const selId=document.getElementById('selId');
const selName=document.getElementById('selName');
const nameSel=document.getElementById('nameSel');
const cxIn=document.getElementById('cx');
const cyIn=document.getElementById('cy');
const rIn=document.getElementById('r');
const imageSel=document.getElementById('imageSel');
const actionSel=document.getElementById('action');
const linkBox=document.getElementById('linkBox');
const msgBox=document.getElementById('msgBox');
const linkIn=document.getElementById('link');
const newtab=document.getElementById('newtab');
const messageIn=document.getElementById('message');

const applyBtn=document.getElementById('apply');
const addBtn=document.getElementById('add');
const removeBtn=document.getElementById('remove');

const exportBtn=document.getElementById('exportBtn');
const importFile=document.getElementById('importFile');
const jsonArea=document.getElementById('jsonArea');
const importArea=document.getElementById('importArea');

const modal=document.getElementById('modal');
const modalText=document.getElementById('modalText');
const modalClose=document.getElementById('modalClose');

/* --- –†–ï–ù–î–ï–† --- */
let selected = zones[0].id;
let editing=false, busy=false;

function render(){
  layer.innerHTML='';
  zones.forEach(z=>{
    // –∫–æ–Ω—Ç—É—Ä –∫—Ä—É–≥–∞
    const outline = document.createElementNS('http://www.w3.org/2000/svg','circle');
    outline.setAttribute('class','zone-outline');
    outline.dataset.id=z.id;
    outline.setAttribute('cx',z.cx); outline.setAttribute('cy',z.cy); outline.setAttribute('r',z.r);
    layer.appendChild(outline);

    // –∫–ª–∏–∫–∞–±–µ–ª—å–Ω–∞—è –∑–æ–Ω–∞ (–æ–±—ã—á–Ω—ã–π —Ä–µ–∂–∏–º)
    const c = document.createElementNS('http://www.w3.org/2000/svg','circle');
    c.setAttribute('class','hotspot');
    c.dataset.id=z.id;
    c.setAttribute('cx',z.cx); c.setAttribute('cy',z.cy); c.setAttribute('r',z.r);
    layer.appendChild(c);

    // —Ü–µ–Ω—Ç—Ä-—Ä—É—á–∫–∞ (‚óè)
    const move = document.createElementNS('http://www.w3.org/2000/svg','circle');
    move.setAttribute('class','move-handle');
    move.dataset.id=z.id;
    move.setAttribute('cx',z.cx); move.setAttribute('cy',z.cy); move.setAttribute('r',10);
    layer.appendChild(move);

    // —Ä—É—á–∫–∞ —Ä–∞–¥–∏—É—Å–∞ (‚ñ†) ‚Äî —Å–ø—Ä–∞–≤–∞
    const rh = document.createElementNS('http://www.w3.org/2000/svg','rect');
    rh.setAttribute('class','radius-handle');
    rh.dataset.id=z.id;
    rh.setAttribute('x', z.cx + z.r - 7); rh.setAttribute('y', z.cy - 7); rh.setAttribute('width',14); rh.setAttribute('height',14);
    layer.appendChild(rh);

    // –ø–æ–¥–ø–∏—Å—å
    const label = document.createElementNS('http://www.w3.org/2000/svg','text');
    label.setAttribute('class','zone-label');
    label.dataset.id=z.id;
    label.setAttribute('x',z.cx); label.setAttribute('y',z.cy - z.r - 10);
    label.setAttribute('text-anchor','middle');
    label.textContent=z.name;
    layer.appendChild(label);
  });
  refreshForm();
  jsonArea.value = JSON.stringify(zones,null,2);
}
render();

function refreshForm(){
  const z = zones.find(q=>q.id===selected) || zones[0];
  if(!z) return;
  selId.textContent=z.id; selName.textContent=z.name;
  nameSel.value=z.name; cxIn.value=Math.round(z.cx); cyIn.value=Math.round(z.cy); rIn.value=Math.round(z.r);
  imageSel.value=z.image || '1.jpg';
  actionSel.value=z.type; linkIn.value=z.link||''; newtab.checked=!!z.newtab; messageIn.value=z.message||'';
  linkBox.style.display = z.type==='link' ? '' : 'none';
  msgBox.style.display  = z.type==='message' ? '' : 'none';
}

/* --- –†–ï–ñ–ò–ú --- */
function setEditing(v){ editing=v; svg.classList.toggle('editing',editing); }
editToggle.addEventListener('change',e=>setEditing(e.target.checked));

/* --- –ö–ª–∏–∫–∏ –≤ –æ–±—ã—á–Ω–æ–º —Ä–µ–∂–∏–º–µ --- */
layer.addEventListener('click', (e)=>{
  if(editing) return;
  const id=e.target.dataset.id; if(!id) return;
  const z=zones.find(q=>q.id===id); if(!z||busy) return;
  busy=true; mapImg.setAttribute('href', z.image||'1.jpg');

  if(z.type==='message'){
    // —Å–ª—É—á–∞–π–Ω—ã–µ —Ç–µ–∫—Å—Ç—ã –¥–ª—è –ª–∞–≥–µ—Ä–µ–π
    if(z.id==='camp_red')    z.message = randomFrom(MSG_RED);
    if(z.id==='camp_yellow') z.message = randomFrom(MSG_YELLOW);
    setTimeout(()=>{ modalText.textContent=z.message||'–°–æ–æ–±—â–µ–Ω–∏–µ'; modal.style.display='grid'; }, 200);
    return;
  }
  if(z.link && z.link!=='#'){
    setTimeout(()=>{ z.newtab?window.open(z.link,'_blank'):window.location.assign(z.link); }, 650);
  }else{
    setTimeout(()=>{ mapImg.setAttribute('href','1.jpg'); busy=false; }, 900);
  }
});

/* --- –í—Å–ø–æ–º–æ–≥–∞—Ç–µ–ª—å–Ω—ã–µ --- */
function svgPoint(evt){
  const pt=svg.createSVGPoint(); pt.x=evt.clientX; pt.y=evt.clientY;
  return pt.matrixTransform(svg.getScreenCTM().inverse());
}
function applySnap(val){ if(!snapToggle.checked) return val; const s=Math.max(1,Number(snapStep.value||8)); return Math.round(val/s)*s; }

function redraw(z){
  const o = layer.querySelector(`.zone-outline[data-id="${z.id}"]`);
  const c = layer.querySelector(`.hotspot[data-id="${z.id}"]`);
  const mh= layer.querySelector(`.move-handle[data-id="${z.id}"]`);
  const rh= layer.querySelector(`.radius-handle[data-id="${z.id}"]`);
  const lb= layer.querySelector(`.zone-label[data-id="${z.id}"]`);
  [o,c].forEach(el=>{
    el.setAttribute('cx',z.cx); el.setAttribute('cy',z.cy); el.setAttribute('r',z.r);
  });
  mh.setAttribute('cx', z.cx); mh.setAttribute('cy', z.cy);
  rh.setAttribute('x', z.cx + z.r - 7); rh.setAttribute('y', z.cy - 7);
  lb.setAttribute('x', z.cx); lb.setAttribute('y', z.cy - z.r - 10); lb.textContent=z.name;
}

/* --- –ü–µ—Ä–µ—Ç–∞—Å–∫–∏–≤–∞–Ω–∏–µ/—Ä–µ—Å–∞–π–∑ ‚Äî —Ç–æ–ª—å–∫–æ —Ä—É—á–∫–∏/–∫–æ–Ω—Ç—É—Ä --- */
let drag=null, resize=null, startP=null, startZ=null, activePointerId=null;

function startDrag(e,id,mode){
  selected=id; refreshForm();
  startP=svgPoint(e); startZ={...zones.find(z=>z.id===id)};
  if(mode==='move')  drag={id};
  if(mode==='size')  resize={id};
  activePointerId=e.pointerId;
  try{ svg.setPointerCapture(activePointerId); }catch{}
}
function endDrag(){
  drag=resize=startP=startZ=null;
  activePointerId=null;
  jsonArea.value=JSON.stringify(zones,null,2);
  refreshForm();
}

layer.addEventListener('pointerdown',e=>{
  if(!editing) return;
  const t=e.target; const id=t.dataset.id; if(!id) return;

  if(t.classList.contains('move-handle') || t.classList.contains('zone-outline')){
    startDrag(e,id,'move');
  }
  if(t.classList.contains('radius-handle')){
    startDrag(e,id,'size');
  }
});
layer.addEventListener('pointermove',e=>{
  if(!(drag||resize)) return;
  const p=svgPoint(e);
  const z=zones.find(q=>q.id===((drag||resize).id)); if(!z) return;

  if(drag){
    const dx=p.x-startP.x, dy=p.y-startP.y;
    z.cx = applySnap(startZ.cx + dx);
    z.cy = applySnap(startZ.cy + dy);
  }
  if(resize){
    const dx=p.x-startZ.cx;
    z.r = Math.max(20, Math.min(400, applySnap(Math.abs(dx))));
  }
  redraw(z);
});
layer.addEventListener('pointerup',e=>{
  if(activePointerId!==null){ try{ svg.releasePointerCapture(activePointerId); }catch{} }
  endDrag();
});
layer.addEventListener('lostpointercapture', endDrag);
layer.addEventListener('pointercancel', endDrag);
window.addEventListener('mouseup', ()=>{ if(drag||resize) endDrag(); });
window.addEventListener('touchend', ()=>{ if(drag||resize) endDrag(); });

/* --- –¢–æ—á–Ω–∞—è –ø–æ–¥–≥–æ–Ω–∫–∞ —Å—Ç—Ä–µ–ª–∫–∞–º–∏ --- */
document.addEventListener('keydown',e=>{
  if(!editing) return;
  const z=zones.find(q=>q.id===selected); if(!z) return;
  const step = e.shiftKey ? 10 : 1;
  if(['ArrowLeft','ArrowRight','ArrowUp','ArrowDown'].includes(e.key)){ e.preventDefault(); }
  if(e.key==='ArrowLeft')  z.cx-=step;
  if(e.key==='ArrowRight') z.cx+=step;
  if(e.key==='ArrowUp')    z.cy-=step;
  if(e.key==='ArrowDown')  z.cy+=step;
  if(e.key==='-')          z.r=Math.max(20, z.r-1);
  if(e.key==='=')          z.r=Math.min(400, z.r+1);
  redraw(z); refreshForm(); jsonArea.value=JSON.stringify(zones,null,2);
});

/* --- –§–æ—Ä–º–∞ --- */
function applyForm(){
  const z=zones.find(q=>q.id===selected); if(!z) return;
  z.name=nameSel.value;
  z.cx=Number(cxIn.value||z.cx);
  z.cy=Number(cyIn.value||z.cy);
  z.r =Number(rIn.value ||z.r);
  z.image=imageSel.value;
  z.type=actionSel.value;
  z.link=linkIn.value.trim();
  z.newtab=!!newtab.checked;
  z.message=messageIn.value.trim();
  redraw(z); refreshForm(); jsonArea.value=JSON.stringify(zones,null,2);
}
applyBtn.addEventListener('click',applyForm);
[nameSel,cxIn,cyIn,rIn,imageSel,actionSel,linkIn,newtab,messageIn].forEach(el=>el.addEventListener('change',applyForm));

/* --- –î–æ–±–∞–≤–∏—Ç—å/–£–¥–∞–ª–∏—Ç—å --- */
addBtn.addEventListener('click',()=>{
  const id='zone_'+Math.random().toString(36).slice(2,7);
  const z={id,name:'–ù–æ–≤–∞—è –∑–æ–Ω–∞',cx:384,cy:576,r:80,type:'link',link:'#',image:'1.jpg',newtab:false};
  zones.push(z); render(); selected=id; refreshForm();
});
removeBtn.addEventListener('click',()=>{
  const i=zones.findIndex(z=>z.id===selected);
  if(i>-1){ zones.splice(i,1); render(); selected=zones[0]?.id; refreshForm(); }
});

/* --- –≠–∫—Å–ø–æ—Ä—Ç/–ò–º–ø–æ—Ä—Ç --- */
exportBtn.addEventListener('click',async()=>{
  const txt=JSON.stringify(zones,null,2);
  jsonArea.value=txt;
  try{ await navigator.clipboard.writeText(txt); exportBtn.textContent='–°–∫–æ–ø–∏—Ä–æ–≤–∞–Ω–æ!'; setTimeout(()=>exportBtn.textContent='–°–∫–æ–ø–∏—Ä–æ–≤–∞—Ç—å JSON',1200); }catch{}
});
importFile.addEventListener('change',async(e)=>{
  const f=e.target.files?.[0]; if(!f) return;
  try{ zones=JSON.parse(await f.text()); render(); }catch{ alert('–ù–µ–∫–æ—Ä—Ä–µ–∫—Ç–Ω—ã–π JSON'); }
});
importArea.addEventListener('click',()=>{
  try{ zones=JSON.parse(jsonArea.value); render(); }catch{ alert('–ù–µ–∫–æ—Ä—Ä–µ–∫—Ç–Ω—ã–π JSON'); }
});

/* --- –ú–æ–¥–∞–ª–∫–∞ --- */
function closeModal(){ modal.style.display='none'; mapImg.setAttribute('href','1.jpg'); busy=false; }
modalClose.addEventListener('click',closeModal);
modal.addEventListener('click',e=>{ if(e.target===modal) closeModal(); });
</script>
</body>
</html>
